## 이벤트 루프

자바스크립트가 싱글 스레드로 한 번에 하나의 태스크만 처리할 수 있다지만 브라우저가 동작하는 것을 보면 가끔 동시에 작업들이 처리되는 것을 느낀적이 있을 것이다. 

자바스크립트는 말 그대로 하나의 작업만 수행하지만 동시에 처리할 수 있는 방법을 지원하는 것이 바로 이벤트 루프다. 이벤트 루프는 브라우저에 내장되어 있는 기능 중 하나.

<hr>

## 자바스크립트 내부 구조
![](https://velog.velcdn.com/images/dhgg321/post/217836ec-7463-44d0-8cf9-57e55bb4ebef/image.png)

먼저 JS라고 적힌 네모 부분이 자바스크립트 코드를 실행하는 엔진 부분이며 오른쪽 그림 중 Web APIs는 JS가 아닌 멀티스레드의 브라우저, Node.js 환경에서 처리하는 비동기 함수다.

자바스크립트 엔진은 크게 2개의 영역으로 구분할 수 있다. 힙과 콜 스택 영역, 이벤트 루프, 콜백 큐 영역. 각 부분들이 어떠한 동작을 수행하는지 살펴보자.

- 콜 스택 

생성된 실행 컨텍스트가 추가되고 제거되는 스택 자료구조, 최상위 작업이 종료되어 콜 스택에서 제거되기 전까지는 다른 태스크는 실행되지 않는다.

- 힙

객체 타입의 변수가 저장되는 메모리 공간. 객체 타입의 변수가 힙에 저장되면 실행 컨텍스트에서 객체 타입 변수를 사용할때 힙에 저장된 객체 주소 값을 참조하게 된다.

- 태스크 큐

비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역. 자료구조 큐의 특징으로 FIFO 특징을 갖는다.

- 이벤트 루프

이벤트 루프는 콜 스택에 현재 실행 중인 실행 컨텍스트가 있는지 그리고 태스크 큐에 대기 중인 콜백함수, 이벤트 핸들러가 있는지 반복해서 확인한다. 

**만약 콜 스택이 비고 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 순차적으로 태스크 큐에 대기 중인 함수를 콜 스택 영억으로 이동시킨다.** 이때 이동된 함수는 실행된다.
<hr>

## 주의 할 점 및 정리

- Web API 영역은 자바스크립트 엔진 영역이 아니다. Web API는 브라우저에서 제공하는 API로 콜 스택에서 비동기 함수가 실행되면 비동기 함수는 Web API를 호출하고 Web API는 콜백함수를 태스크 큐에 밀어 넣는다.
<br><br>
브라우저는 멀티 스레드로 동작하며 비동기 작업이 끝나면 콜백 함수를 태스크 큐에 푸시하는 것은 브라우저의 역할이다.

- 콜 스택에서 비동기 실행 컨텍스트가 호출되면 작업을 브라우저 Web API에 위임하고 콜 스택에서 Pop 제거된다. 이때 자바스크립트의 콜 스택에서는 다른 작업을 할 수 있기에 비동기 처럼 작동하는 것이지 자바스크립트 엔진은 계속해서 싱글 스레드로 동작한다.
<br><br>
Web API에서 비동기 작업이 완료되면 브라우저는 태스크 큐로 콜백 함수들을 집어 넣는다. 이때 이벤트 큐는 콜 스택이 비었는지, 태스크 큐에 콜백 함수가 있는지 계속 확인을 하고 콜 스택이 비었다면 태스크 큐에서 FIFO 구조의 순차적으로 콜 스택으로 이동하여 콜백 함수를 실행한다.




<hr>
